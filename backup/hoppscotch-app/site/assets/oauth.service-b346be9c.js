var P=Object.defineProperty;var U=(e,t,r)=>t in e?P(e,t,{enumerable:!0,configurable:!0,writable:!0,value:r}):e[t]=r;var A=(e,t,r)=>(U(e,typeof t!="symbol"?t+"":t,r),r);import{cP as I,aK as T,a5 as N,cQ as D,cR as a,cS as f,cT as o,cF as E,cU as y,cV as V}from"./index-7d8b347c.js";const S=I(T),F=I(N),v=D.pick({authEndpoint:!0,tokenEndpoint:!0,clientID:!0,clientSecret:!0,scopes:!0,isPKCE:!0,codeVerifierMethod:!0}).refine(e=>e.authEndpoint.length>=1&&e.tokenEndpoint.length>=1&&e.clientID.length>=1&&(!e.scopes||e.scopes.trim().length>=1),{message:"Minimum length requirement not met for one or more parameters"}).refine(e=>e.isPKCE?!!e.codeVerifierMethod:!0,{message:"codeVerifierMethod is required when using PKCE",path:["codeVerifierMethod"]}),W=()=>({authEndpoint:"",tokenEndpoint:"",clientID:"",clientSecret:"",scopes:void 0,isPKCE:!1,codeVerifierMethod:"S256"}),H=async({tokenEndpoint:e,clientID:t,clientSecret:r,scopes:n,authEndpoint:c,isPKCE:h,codeVerifierMethod:s})=>{const i=C();let u,l;h&&(u=x(),l=await b(u,s));let g={state:i,grant_type:"AUTHORIZATION_CODE",authEndpoint:c,tokenEndpoint:e,clientSecret:r,clientID:t,isPKCE:h,codeVerifierMethod:s,scopes:n};u&&l&&(g={...g,codeVerifier:u,codeChallenge:l});const m=S.getLocalConfig("oauth_temp_config"),_=m?{...JSON.parse(m)}:{},{grant_type:w,...L}=g;S.setLocalConfig("oauth_temp_config",JSON.stringify({..._,fields:L,grant_type:w}));let d;try{d=new URL(c)}catch{return a("INVALID_AUTH_ENDPOINT")}return d.searchParams.set("grant_type","authorization_code"),d.searchParams.set("client_id",t),d.searchParams.set("state",i),d.searchParams.set("response_type","code"),d.searchParams.set("redirect_uri",p.redirectURI),n&&d.searchParams.set("scope",n),s&&l&&(d.searchParams.set("code_challenge",l),d.searchParams.set("code_challenge_method",s)),window.location.assign(d.toString()),f(void 0)},k=async e=>{const t=new URLSearchParams(window.location.search),r=t.get("code"),n=t.get("state");if(t.get("error"))return a("AUTH_SERVER_RETURNED_ERROR");if(!r)return a("AUTH_TOKEN_REQUEST_FAILED");const s=o.object({source:o.optional(o.string()),state:o.string(),tokenEndpoint:o.string(),clientSecret:o.string(),clientID:o.string(),codeVerifier:o.string().optional(),codeChallenge:o.string().optional()}).safeParse(JSON.parse(e).fields);if(!s.success)return a("INVALID_LOCAL_CONFIG");if(s.data.state!==n)return a("INVALID_STATE");const i=new URLSearchParams;i.append("grant_type","authorization_code"),i.append("code",r),i.append("client_id",s.data.clientID),i.append("client_secret",s.data.clientSecret),i.append("redirect_uri",p.redirectURI),s.data.codeVerifier&&i.append("code_verifier",s.data.codeVerifier);const{response:u}=F.runRequest({url:s.data.tokenEndpoint,method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},data:i.toString()}),l=await u;if(E(l))return a("AUTH_TOKEN_REQUEST_FAILED");const g=z(l.right);if(E(g))return a("AUTH_TOKEN_REQUEST_FAILED");const _=o.object({access_token:o.string()}).safeParse(g.right);return _.success?f(_.data):a("AUTH_TOKEN_REQUEST_INVALID_RESPONSE")},x=()=>{const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~",t=Math.floor(Math.random()*86)+43;let r="";for(let n=0;n<t;n++){const c=Math.floor(Math.random()*e.length);r+=e[c]}return r},b=async(e,t)=>{if(t==="plain")return e;const n=new TextEncoder().encode(e),c=await crypto.subtle.digest("SHA-256",n);return K(c)},K=e=>{const t=Array.from(new Uint8Array(e));return btoa(String.fromCharCode(...t)).replace(/=/g,"").replace(/\+/g,"-").replace(/\//g,"_")},M=R("AUTHORIZATION_CODE",v,H,k),O=I(T),J=y.pick({authEndpoint:!0,clientID:!0,scopes:!0}).refine(e=>e.authEndpoint.length>=1&&e.clientID.length>=1&&(e.scopes===void 0||e.scopes.length>=1)),X=()=>({authEndpoint:"",clientID:"",scopes:void 0}),Q=async({clientID:e,scopes:t,authEndpoint:r})=>{const n=C(),c=O.getLocalConfig("oauth_temp_config"),h=c?{...JSON.parse(c)}:{};O.setLocalConfig("oauth_temp_config",JSON.stringify({...h,fields:{clientID:e,authEndpoint:r,scopes:t,state:n},grant_type:"IMPLICIT"}));let s;try{s=new URL(r)}catch{return a("INVALID_AUTH_ENDPOINT")}return s.searchParams.set("client_id",e),s.searchParams.set("state",n),s.searchParams.set("response_type","token"),s.searchParams.set("redirect_uri",p.redirectURI),t&&s.searchParams.set("scope",t),window.location.assign(s.toString()),f(void 0)},j=async e=>{const t=new URLSearchParams(window.location.search),r=new URLSearchParams(window.location.hash.substring(1)),n=t.get("access_token")||r.get("access_token"),c=t.get("state")||r.get("state");if(t.get("error")||r.get("error"))return a("AUTH_SERVER_RETURNED_ERROR");if(!n)return a("AUTH_TOKEN_REQUEST_FAILED");const i=o.object({source:o.optional(o.string()),state:o.string(),clientID:o.string()}).safeParse(JSON.parse(e).fields);return i.success?i.data.state!==c?a("INVALID_STATE"):f({access_token:n}):a("INVALID_LOCAL_CONFIG")},B=R("IMPLICIT",J,Q,j),q=I(T),Y=["AUTHORIZATION_CODE","IMPLICIT"],ee=async()=>{const e=q.getLocalConfig("oauth_temp_config");if(!e)return a("INVALID_STATE");const r=o.object({source:o.optional(o.string()),grant_type:o.string()}).safeParse(JSON.parse(e));if(!r.success)return a("INVALID_STATE");const n=[M,B].find(c=>c.flow===r.data.grant_type);return n?n==null?void 0:n.onRedirectReceived(e):a("INVALID_STATE")};function R(e,t,r,n){return{flow:e,params:t,init:r,onRedirectReceived:n}}const z=e=>{try{const t=new TextDecoder("utf-8").decode(e.data).replaceAll("\0","");return f(JSON.parse(t))}catch{return a("AUTH_TOKEN_REQUEST_FAILED")}};class p extends V{}A(p,"ID","OAUTH_AUTH_SERVICE"),A(p,"redirectURI",`${window.location.origin}/oauth`);const C=()=>{const t="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";return crypto.getRandomValues(new Uint8Array(64)).reduce((n,c)=>n+t[c%t.length],"")};export{p as O,M as a,W as b,R as c,z as d,X as e,Y as g,B as i,ee as r};
//# sourceMappingURL=oauth.service-b346be9c.js.map
